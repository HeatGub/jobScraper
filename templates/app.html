<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plot and Table</title>

  {{ resources|safe }}

  <style>
    form, table {
      width: 100%;
      /* margin: 0;
      padding: 0; */
      text-align: center;
    }
    th, td {
      border: 1px solid black;
    }
    td > input {
      width: 97%;
    }
    /* td:nth-child(1) {
      max-width: 70px;
    }
    td:nth-child(2) { 
      max-width: 10px;
    }
    td:nth-child(5), td:nth-child(6){
      max-width: 70px;
    } */
    #downloadCsv {
      /* just for visibility */
      /* border: 1px blue solid; */
      color: blue;
    }
  </style>
</head>

<body>

  <br><br>
  <button id="fetchWorkerBtn">Fetch Worker</button>
  <div id="fetchWorkerCounter"></div>
  <br><br>

  <form id="mainForm">
    <table>
      <thead>
        <tr>
          <th scope="col">parameter</th>
          <th scope="col">show in table <p class="checkUncheckAll">UNCHECK ALL</p></th>
          <th scope="col">necessary</th>
          <th scope="col">forbidden</th>
          <th scope="col">above</th>
          <th scope="col">below</th>
        </tr>
      </thead>
      {% for column in columnsAll %}
      <tr>
        <td>{{column}}</td>
        <td><input type="checkbox" class="ckeckBox" checked="checked" name={{column}}Show></td>
        {% if column != "salaryMin" and column != "salaryMax" %}
        <!-- oninput="this.size = this.value.length" makes it resize, but it might be unnecessary -->
        <td><input type="text" placeholder="necessary phrase" name={{column}}Necessary></td>
        <td><input type="text" placeholder="forbidden phrase" name={{column}}Forbidden></td>
        {% elif column == "salaryMin" or column == "salaryMax" %}
        <td></td>
        <td></td>
        {% endif %}
        {% if column == "datetimeFirst" or column == "datetimeLast" %}
        <td><input type="datetime-local" placeholder="above" name={{column}}Above></td>
        <td><input type="datetime-local" placeholder="below" name={{column}}Below></td>
        {% elif column == "salaryMin" or column == "salaryMax" %}
        <td><input type="number" placeholder="4000" name={{column}}Above></td>
        <td><input type="number" placeholder="10000" name={{column}}Below></td>
        {% endif %}
      </tr>
      {% endfor %}
    </table>
    <input type="submit" value="submit" id="sendFormAndFetchBokehBtn">
  </form>

  <h1 id="resultsAmount"></h1>
  <a id="downloadCsv" href="{{ url_for('downloadCsv') }}" class="btn"></a>
  <div id="plotDiv"></div>
  <br>
  <div id="tableDiv"></div>

  <script>
    document.getElementById("fetchWorkerBtn").addEventListener("click", startTimer)
    //  MAKE IT STOP FETCHING WHEN NO CONNECTION 
    function fetchWorker() {
        output = document.getElementById('fetchWorkerCounter')
        try {
            fetch(window.origin + '/worker', {
                credentials: "include", //cookies etc
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            }) //fetch returns async promise, then do something
                .then(function (response) {
                    if (response.status !== 200) {
                        console.log('response status not 200: ' + response.status)
                        clearInterval(runningTimer) //TURN OFF THE TIMER IF ERROR
                        return
                    }
                    response.json().then(function (data) {
                        output.innerText = data
                        console.log(data)
                        if (data === 'TASK ENDED') { //TURN OFF THE TIMER IF DONE
                            clearInterval(runningTimer)
                            return
                        }
                    })
                })
        }
        catch (error) { //DOESNT REACH THIS POINT
            console.log('ERROR CATCHED' + error)
            clearInterval(runningTimer) //stops timer - stops sending the requests}
        }
    }

    function startTimer() {
        //STOP IF ALREADY SET
        if (typeof runningTimer !== 'undefined') {
            clearInterval(runningTimer) //stops timer - stops sending the requests 
        }
        intervalInMiliseconds = 500
        runningTimer = setInterval(fetchWorker, intervalInMiliseconds); //100ms interval
    }

</script>

  <script>
    document.getElementById("sendFormAndFetchBokehBtn").addEventListener("click", sendFormAndFetchBokeh)

    function sendFormAndFetchBokeh(e) {
      e.preventDefault() //prevent sending form default request
      const form = document.getElementById('mainForm')
      var formData = new FormData(form)

      //remove T from datetimes for further processing
      listToRegexp = ['datetimeFirstAbove', 'datetimeFirstBelow', 'datetimeLastAbove', 'datetimeLastBelow']
      listToRegexp.forEach( (param) => {
        if (formData.get(param)) {
          oldValue = formData.get(param)
          newValue = oldValue.replace('T', ' ') //replace T with space to fit SQL
          formData.set(param, newValue)
          // console.log(formData.get(param))
        }
      })

      formDataJson = JSON.stringify(Object.fromEntries(formData))
      // console.log(formDataJson)

      fetch(window.origin + '/', {
        method: "POST",
        credentials: "include", //cookies etc
        body: formDataJson,
        cache: "no-cache",
        headers: new Headers({
          "content-type": "application/json"
        })
      }) //fetch returns async promise, then do something
        .then(function (response) {
          if (response.status !== 200) {
            console.log('Error fetching. Response code: ' + response.status)
            return
          }
          else if (response.status == 200) {
            return response.json()
          }
        })
        .then(function (items) { //when response 200 and JSON items list received
          //when no results
          if (items[0] === 'noResultsFound') {
            document.getElementById('plotDiv').innerHTML = 'no data'
            document.getElementById('tableDiv').innerHTML = 'no data'
            document.getElementById('downloadCsv').innerHTML = ''
            document.getElementById('resultsAmount').innerHTML = 'no results ¯\\_(ツ)_/¯'
          }
          //if all went good and results are not empty replace the divs with bokeh stuff
          else if (items[0] && items[1] && items[2]) { //plot, table, and amount of results
            document.getElementById('plotDiv').innerHTML = '' //make div empty first
            document.getElementById('tableDiv').innerHTML = ''
            Bokeh.embed.embed_item(items[0], 'plotDiv')
            Bokeh.embed.embed_item(items[1], 'tableDiv')
            document.getElementById('downloadCsv').innerHTML = 'Download CSV'
            if (items[2] === 1) { //if 1 result
              document.getElementById('resultsAmount').innerHTML = '1 result'
            }
            else if (items[2] > 1) { // if >1 results
              document.getElementById('resultsAmount').innerHTML = items[2] + ' results'
            }
          }
        })
    }
  </script>

  <script>
    //CHANGING CHECKBOXES STATE - CHECK/UNCHECK
    document.querySelector('.checkUncheckAll').addEventListener('click', (event) => {
      if (document.querySelector('.checkUncheckAll').textContent == 'UNCHECK ALL') {
        document.querySelectorAll('.ckeckBox').forEach(checkbox => { checkbox.checked = false })
        document.querySelector('.checkUncheckAll').textContent = 'CHECK ALL'
      }
      else if (document.querySelector('.checkUncheckAll').textContent == 'CHECK ALL') {
        document.querySelectorAll('.ckeckBox').forEach(checkbox => { checkbox.checked = true })
        document.querySelector('.checkUncheckAll').textContent = 'UNCHECK ALL'
      }
    })
  </script>

</body>

</html>